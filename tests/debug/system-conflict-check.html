<!DOCTYPE html>
<html>
<head>
    <title>System Conflict Check</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .active { color: green; font-weight: bold; }
        .inactive { color: gray; }
        .conflict { color: red; font-weight: bold; }
        table { border-collapse: collapse; margin: 20px 0; }
        td, th { border: 1px solid #ccc; padding: 8px; }
    </style>
</head>
<body>
    <h1>System Conflict Check</h1>
    <p>This shows which collaborative systems are active and potentially conflicting.</p>
    
    <button onclick="checkSystems()">Check Active Systems</button>
    <button onclick="checkEventListeners()">Check Event Listeners</button>
    
    <div id="results"></div>
    
    <script>
        function checkSystems() {
            const win = window.open('/', 'mainApp', 'width=1200,height=800');
            
            setTimeout(() => {
                if (!win.app) {
                    document.getElementById('results').innerHTML = '<p class="conflict">App not loaded</p>';
                    return;
                }
                
                const results = document.getElementById('results');
                let html = '<h2>Active Systems</h2><table>';
                html += '<tr><th>System</th><th>Status</th><th>Details</th></tr>';
                
                // Check each system
                const systems = [
                    {
                        name: 'NetworkLayer (NEW)',
                        exists: !!win.app.networkLayer,
                        connected: win.app.networkLayer?.isConnected,
                        details: win.app.networkLayer ? `Connected: ${win.app.networkLayer.isConnected}, Project: ${win.app.networkLayer.currentProject?.id}` : 'Not found'
                    },
                    {
                        name: 'OperationPipeline (NEW)',
                        exists: !!win.app.operationPipeline,
                        connected: true,
                        details: win.app.operationPipeline ? 'Active' : 'Not found'
                    },
                    {
                        name: 'CollaborativeArchitecture (NEW)',
                        exists: !!win.app.collaborativeArchitecture,
                        connected: true,
                        details: win.app.collaborativeArchitecture ? 'Initialized' : 'Not found'
                    },
                    {
                        name: 'CollaborativeManager (LEGACY)',
                        exists: !!win.app.collaborativeManager,
                        connected: win.app.collaborativeManager?.isConnected,
                        details: win.app.collaborativeManager ? `Connected: ${win.app.collaborativeManager.isConnected}` : 'Not found'
                    },
                    {
                        name: 'ActionManager (LEGACY)',
                        exists: !!win.app.graphCanvas?.actionManager,
                        connected: true,
                        details: win.app.graphCanvas?.actionManager ? 'Active on canvas' : 'Not found'
                    },
                    {
                        name: 'UnifiedOperationHandler (LEGACY)',
                        exists: !!win.UnifiedOperationHandler,
                        connected: true,
                        details: win.UnifiedOperationHandler ? 'Class exists' : 'Not found'
                    },
                    {
                        name: 'TransactionManager (LEGACY)',
                        exists: !!win.TransactionManager,
                        connected: true,
                        details: win.TransactionManager ? 'Class exists' : 'Not found'
                    }
                ];
                
                let conflicts = 0;
                systems.forEach(sys => {
                    const isNew = sys.name.includes('NEW');
                    const isLegacy = sys.name.includes('LEGACY');
                    const status = sys.exists ? (isLegacy ? 'CONFLICT' : 'ACTIVE') : 'INACTIVE';
                    
                    if (sys.exists && isLegacy) conflicts++;
                    
                    html += `<tr>`;
                    html += `<td>${sys.name}</td>`;
                    html += `<td class="${status === 'CONFLICT' ? 'conflict' : status === 'ACTIVE' ? 'active' : 'inactive'}">${status}</td>`;
                    html += `<td>${sys.details}</td>`;
                    html += `</tr>`;
                });
                
                html += '</table>';
                
                if (conflicts > 0) {
                    html += `<p class="conflict">⚠️ Found ${conflicts} legacy systems that may conflict with the new architecture!</p>`;
                    html += '<p>These legacy systems should be disabled to prevent race conditions.</p>';
                }
                
                // Check for operation broadcasts
                html += '<h3>Operation Flow</h3>';
                html += '<ul>';
                
                // Check which system handles operations
                const canvas = win.app.graphCanvas;
                if (canvas) {
                    html += `<li>Canvas actionManager: ${canvas.actionManager ? '<span class="conflict">SET (will intercept operations)</span>' : '<span class="active">NULL (good)</span>'}</li>`;
                    html += `<li>Canvas collaborativeManager: ${canvas.collaborativeManager ? '<span class="conflict">SET (may broadcast duplicates)</span>' : '<span class="active">NULL (good)</span>'}</li>`;
                }
                
                html += '</ul>';
                
                results.innerHTML = html;
            }, 2000);
        }
        
        function checkEventListeners() {
            const win = window.open('', 'mainApp');
            if (!win || !win.app) {
                document.getElementById('results').innerHTML = '<p class="conflict">Window not found</p>';
                return;
            }
            
            const results = document.getElementById('results');
            let html = '<h2>Event Listeners</h2>';
            
            // Check socket listeners
            if (win.app.networkLayer?.socket) {
                const socket = win.app.networkLayer.socket;
                html += '<h3>NetworkLayer Socket Events</h3><ul>';
                const events = socket._callbacks || {};
                Object.keys(events).forEach(event => {
                    html += `<li>${event}: ${events[event].length} listeners</li>`;
                });
                html += '</ul>';
            }
            
            if (win.app.collaborativeManager?.socket) {
                const socket = win.app.collaborativeManager.socket;
                html += '<h3>CollaborativeManager Socket Events</h3><ul>';
                const events = socket._callbacks || {};
                Object.keys(events).forEach(event => {
                    html += `<li>${event}: ${events[event].length} listeners</li>`;
                });
                html += '</ul>';
            }
            
            results.innerHTML += html;
        }
    </script>
</body>
</html>