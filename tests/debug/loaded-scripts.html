<!DOCTYPE html>
<html>
<head>
    <title>Loaded Scripts Check</title>
    <script>
        // Store original scripts
        const originalScripts = Array.from(document.scripts).map(s => s.src);
    </script>
</head>
<body>
    <h1>Scripts Loaded in Main App</h1>
    <button onclick="checkScripts()">Check Scripts in Main Window</button>
    <button onclick="injectNetworkLayer()">Manually Inject NetworkLayer</button>
    <pre id="result"></pre>
    
    <script>
        function checkScripts() {
            // Open main app in new window to check
            const win = window.open('/', 'mainApp', 'width=800,height=600');
            
            setTimeout(() => {
                const result = document.getElementById('result');
                result.textContent = 'Checking loaded scripts...\n\n';
                
                // Get all scripts
                const scripts = Array.from(win.document.scripts);
                result.textContent += `Total scripts: ${scripts.length}\n\n`;
                
                // Check for our scripts
                const ourScripts = [
                    'NetworkLayer.js',
                    'OperationPipeline.js',
                    'CollaborativeArchitecture.js',
                    'MigrationAdapter.js',
                    'CanvasIntegration.js',
                    'AutoInit.js',
                    'Command.js',
                    'NodeCommands.js'
                ];
                
                result.textContent += 'New Architecture Scripts:\n';
                ourScripts.forEach(scriptName => {
                    const found = scripts.find(s => s.src.includes(scriptName));
                    result.textContent += `${scriptName}: ${found ? '✅ Loaded from ' + found.src : '❌ Not loaded'}\n`;
                });
                
                result.textContent += '\n\nAll loaded scripts:\n';
                scripts.forEach((s, i) => {
                    if (s.src) {
                        result.textContent += `${i + 1}. ${s.src}\n`;
                    }
                });
                
                // Check window objects
                result.textContent += '\n\nWindow objects:\n';
                result.textContent += `NetworkLayer: ${typeof win.NetworkLayer}\n`;
                result.textContent += `OperationPipeline: ${typeof win.OperationPipeline}\n`;
                result.textContent += `CollaborativeArchitecture: ${typeof win.CollaborativeArchitecture}\n`;
                result.textContent += `window.app: ${win.app ? 'exists' : 'not found'}\n`;
                
                if (win.app) {
                    result.textContent += `app.networkLayer: ${win.app.networkLayer ? 'exists' : 'not found'}\n`;
                }
            }, 3000); // Wait for scripts to load
        }
        
        function injectNetworkLayer() {
            const win = window.open('/', 'mainApp', 'width=800,height=600');
            
            setTimeout(() => {
                const result = document.getElementById('result');
                result.textContent = 'Injecting NetworkLayer...\n';
                
                // Inject the script
                const script = win.document.createElement('script');
                script.src = '/js/core/NetworkLayer.js';
                script.onload = () => {
                    result.textContent += 'NetworkLayer.js injected and loaded\n';
                    result.textContent += `typeof NetworkLayer: ${typeof win.NetworkLayer}\n`;
                    
                    if (typeof win.NetworkLayer !== 'undefined' && win.app) {
                        result.textContent += '\nCreating NetworkLayer instance...\n';
                        try {
                            win.app.networkLayer = new win.NetworkLayer(win.app);
                            result.textContent += 'NetworkLayer instance created!\n';
                            result.textContent += `Status: ${JSON.stringify(win.app.networkLayer.getStatus())}\n`;
                            
                            // Try to connect
                            result.textContent += '\nAttempting connection...\n';
                            win.app.networkLayer.connect().then(() => {
                                result.textContent += '✅ Connected!\n';
                            }).catch(e => {
                                result.textContent += `❌ Connection failed: ${e.message}\n`;
                            });
                        } catch (e) {
                            result.textContent += `Error creating instance: ${e.message}\n`;
                        }
                    }
                };
                script.onerror = () => {
                    result.textContent += '❌ Failed to load NetworkLayer.js\n';
                };
                win.document.head.appendChild(script);
            }, 2000);
        }
    </script>
</body>
</html>